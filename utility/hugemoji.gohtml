{{- /*
  Author: Vladlena Costescu (@lbds137)
  Trigger type: `Command`
  Trigger: `hugemoji`
  Dependencies: `embed_exec`
*/ -}}

{{ $globalCategoryID := toInt (dbGet 0 "Global").Value }}
{{ $commandsCategoryID := toInt (dbGet 0 "Commands").Value }}
{{ $rolesCategoryID := toInt (dbGet 0 "Roles").Value }}
{{ $channelsCategoryID := toInt (dbGet 0 "Channels").Value }}

{{ $deleteTriggerDelay := or (toInt (dbGet $globalCategoryID "Delete Trigger Delay").Value) 5 }}
{{ $deleteResponseDelay := or (toInt (dbGet $globalCategoryID "Delete Response Delay").Value) 5 }}
{{ $embed_exec := toInt (dbGet $commandsCategoryID "embed_exec").Value }}
{{ $staffRoleID := toInt (dbGet $rolesCategoryID "Staff Role ID").Value }}
{{ $yagpdbChannelID := toInt (dbGet $channelsCategoryID "YAGPDB Channel ID").Value }}

{{ $emojiRegex := "<a?:[[:word:]]{2,}:\\d{16,}>" }}
{{ $animatedEmojiRegex := "<a:[[:word:]]{2,}:\\d{16,}>" }}
{{ $emojiIDRegex := "\\d{16,}" }}
{{ $baseURLRegex := "https://(ptb.|canary.)?discord(?:app)?.com/channels/" }}
{{ $fullURLRegex := joinStr "" $baseURLRegex "\\d{16,}/\\d{16,}/\\d{16,}" }}
{{ $ccExecLimit := 10 }}

{{ $args := parseArgs 1 "Usage: `[emoji(s) and / or message link(s)]`"
  (carg "string" "emoji(s) and / or message link(s)")
}}
{{ $arg := $args.Get 0 }}

{{ $emojiStrMsgLinkDict := sdict }}
{{ $msgLinks := reFindAll $fullURLRegex $arg }}
{{ $triggerMsgObj := .Message }}
{{ $triggerMsg := $triggerMsgObj.Content }}
{{ $staffCheck := hasRoleID $staffRoleID }}
{{ $thisChannelNSFW := (getChannelOrThread $triggerMsgObj.ChannelID).NSFW }}
{{- range $msgLink := $msgLinks -}}
  {{- $msgLinkSlice := split $msgLink "/" -}}
  {{- $mlsLen := len $msgLinkSlice -}}
  {{- $guildID := index $msgLinkSlice (sub $mlsLen 3) -}}
  {{- $channelID := index $msgLinkSlice (sub $mlsLen 2) -}}
  {{- $messageID := index $msgLinkSlice (sub $mlsLen 1) -}}
  {{- $msg := getMessage $channelID $messageID -}}

  {{- $guildCheck := eq $triggerMsgObj.GuildID (toInt $guildID) -}}
  {{- $thatChannelNSFW := "" -}}
  {{- if getChannelOrThread $channelID -}}
    {{- $thatChannelNSFW = (getChannelOrThread $channelID).NSFW -}}
  {{- end -}}
  {{- $nsfwCheck := or (not $thatChannelNSFW) (and $thisChannelNSFW $thatChannelNSFW) -}}

  {{- if and $msg $guildCheck (or $staffCheck $nsfwCheck) -}}
    {{- range $emojiStr := reFindAll $emojiRegex $msg.Content -}}
      {{- $emojiStrMsgLinkDict.Set $emojiStr $msgLink -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- range $emojiStr := reFindAll $emojiRegex $arg -}}
  {{- $emojiStrMsgLinkDict.Set $emojiStr "" -}}
{{- end -}}

{{ $userID := .User.ID }}
{{ $channelID := .Channel.ID }}
{{ $i := 0 }}
{{ $tooManyEmojis := false }}
{{- range $emojiStr, $msgLink := $emojiStrMsgLinkDict -}}
  {{- if lt $i $ccExecLimit -}}
    {{- $fileExtension := ".png" -}}
    {{- if reFind $animatedEmojiRegex $emojiStr -}}
      {{- $fileExtension = ".gif" -}}
    {{- end -}}
    {{- $emojiStrParts := split $emojiStr ":" -}}
    {{- $emojiName := index $emojiStrParts 1 -}}
    {{- $emojiUrl := joinStr ""
      "https://cdn.discordapp.com/emojis/" (reFind $emojiIDRegex $emojiStr) $fileExtension "?v=1" -}}

    {{- $fields := cslice (sdict "name" "Name" "value" $emojiName "inline" false) -}}
    {{- if $msgLink -}}
      {{- $msgLinkString := joinStr "" "üîó [Click or tap here to view the message.](" $msgLink ")" -}}
      {{- $fields = $fields.Append (sdict "name" "Original Message" "value" $msgLinkString "inline" false) -}}
    {{ end }}

    {{- execCC $embed_exec $yagpdbChannelID 0 (sdict
      "AuthorID" $userID
      "ChannelID" $channelID
      "Title" "Emoji Expander"
      "ImageURL" $emojiUrl
      "Fields" $fields
    ) -}}
  {{- else if not $tooManyEmojis -}}
    {{- $tooManyEmojis = true -}}
  {{- end -}}
  {{- $i = add 1 $i -}}
{{- end -}}

{{ deleteTrigger $deleteTriggerDelay }}

{{ if $tooManyEmojis }}
  {{- /* timing is notoriously unreliable with `execCC` so wait a while before sending the error message */ -}}
  {{ sleep 10 }}
  {{ $emojiIgnoredCount := sub $i $ccExecLimit }}
  {{ $subjectAndVerb := "" }}
  {{ if eq 1 $emojiIgnoredCount }}
    {{ $subjectAndVerb = "emoji was" }}
  {{ else }}
    {{ $subjectAndVerb = "emojis were" }}
  {{ end }}
  {{ $errorMsgID := sendMessageRetID $channelID (joinStr " "
    "‚ö†Ô∏è Warning:" $emojiIgnoredCount $subjectAndVerb "not displayed because only" $ccExecLimit "emojis can be expanded at a time."
  ) }}
  {{ deleteMessage $channelID $errorMsgID $deleteResponseDelay }}
{{ end }}
